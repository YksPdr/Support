DECLARE @ID int
DECLARE @SENHA VARCHAR(35)
DECLARE @CRYPT VARBINARY(MAX)

DECLARE seila_cursor CURSOR FOR 
SELECT idPESSOA, 
	   SN_PESSOA, 
	   DT_PESSOA, 
	   NM_PESSOA 
FROM PESSOAS 
WHERE ST_PESSOA = 'A'

OPEN seila_cursor
FETCH NEXT FROM seila_cursor INTO @ID

WHILE @@FETCH_STATUS = 0
BEGIN
	SELECT @SENHA = SN_PESSOA, DT_PESSOA FROM PESSOAS WHERE idPESSOA = @ID

	IF EXISTS (SELECT 1 FROM SENHAS_ACESSO WHERE idACESSO = @ID)
	BEGIN

		INSERT INTO SENHAS_ACESSO (idACESSO, DA_SENHAACESSO, SE_SENHAACESSO)
		VALUES (@ID, EncryptByPassPhrase(NM_PESSOA, @SENHA))

		UPDATE ACESSO
		SET DC_ACESSO = GETDATE()
		WHERE idPESSOA = @ID

	END
	ELSE
	BEGIN

		INSERT INTO ACESSO (idACESSO, idPESSOA, DC_ACESSO, DS_ACESSO, VS_ACESSO, SE_ACESSO)

		FETCH NEXT FROM seila_cursor INTO @ID

	END
END

CLOSE seila_cursor
DEALLOCATE seila_cursor